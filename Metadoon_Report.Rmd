---
title: "Metadoon Analysis Report"
output: 
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
fontsize: 11pt
geometry: margin=1in
---

```{r setup, include=FALSE}
# --- CONFIGURAÇÃO LEVE ---
library(knitr)
library(jsonlite)
library(rprojroot)

knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE, 
  warning = FALSE, 
  fig.align = 'center',
  results = 'asis', 
  out.width = "90%"
)

# Localiza a pasta Output (Flat structure: all PNGs inside Output/)
script_dir <- tryCatch(find_root(has_file("Analise.R")), error = function(e) getwd())
output_dir <- file.path(script_dir, "Output")

print_warning <- function(msg) {
  cat(paste0("<div class='alert alert-warning' style='padding: 10px; border: 1px solid transparent; border-radius: 4px; color: #8a6d3b; background-color: #fcf8e3; border-color: #faebcc;'><strong>Note:</strong> ", msg, "</div>\n"))
}
```

# Rarefaction Curve

The rarefaction curve provides insight into the richness of microbial communities across samples. It estimates the number of observed species (or OTUs) as a function of the sequencing depth. A plateau indicates sufficient sampling depth. A rarefaction curve graphically represents the expected number of observed species (or operational taxonomic units, OTUs) in microbial communities as sequencing depth increases through repeated random subsampling of reads. This standardization allows fair comparisons of species richness across samples with unequal sequencing efforts, mitigating biases from varying library sizes.

## Applications in Microbiome Analysis

Rarefaction assesses sampling completeness and alpha diversity (richness and evenness within samples), essential for metagenomic studies like 16S rRNA or shotgun sequencing. Despite debates on its limitations for rare species extrapolation, it remains a robust normalization method for uneven data.

```{r rarefact_data, include=TRUE, echo= FALSE}
# Search directly in Output/
rare_file <- file.path(output_dir, "rarefaction_curve.png")

if(file.exists(rare_file)) {
  knitr::include_graphics(rare_file)
} else {
  print_warning("Rarefaction curve not generated.")
}
```

### Interpretation: 
Samples that plateau have been sequenced to near saturation. - Curves that rise sharply with no sign of plateau suggest under-sampling.

# Relative abundance:

Relative abundance analysis illustrates the proportional representation of microbial taxa within each sample, typically aggregated at different taxonomic levels (e.g., Phylum, Genus). These stacked bar plots help visualize shifts in the dominant microbial community composition across experimental groups or conditions.

```{r relative_abundance, include=TRUE, echo= FALSE}
ranks <- c("Phylum", "Class", "Order", "Family", "Genus")
found_any <- FALSE

for(rank in ranks) {
  # Search directly in Output/
  img <- file.path(output_dir, paste0("abundance_", rank, ".png"))
  if(file.exists(img)) {
    found_any <- TRUE
    cat(paste0("\n### ", rank, "\n"))
    cat(paste0("![](", img, ")\n"))
  }
}

if(!found_any) {
  print_warning("No Abundance plots found.")
}
```
### Interpretation: 
-   Each bar represents the composition of one sample, with colors indicating the relative proportions of taxa.

-   Taxa with higher proportions (larger segments) dominate the microbial community.

-   Group-wise comparisons allow identification of patterns or shifts in community structure (e.g., enrichment or depletion of specific taxa).

-   The "Others" category groups less abundant taxa to reduce noise and improve clarity.

# Core-Microbiome:

The core microbiome refers to the set of microbial taxa that are consistently detected across a defined proportion of samples within a group. Identifying core taxa is essential for understanding the stable and potentially functionally important members of the microbial community. In the heatmaps below, prevalence (frequency of detection) and detection thresholds (minimum relative abundance) are used to determine which taxa are considered part of the core microbiome.

```{r core_microbiome, include=TRUE, echo=FALSE, out.extra='style="margin-top:60px;"', out.width="100%"}
found_any <- FALSE
for(rank in ranks) {
  img <- file.path(output_dir, paste0("core_microbiome_heatmap_", rank, ".png"))
  if(file.exists(img)) {
    found_any <- TRUE
    cat(paste0("\n### ", rank, "\n"))
    cat(paste0("![](", img, ")\n"))
  }
}

if(!found_any) {
  print_warning("Core Microbiome analysis skipped (insufficient prevalence or data structure).")
}
```
### Interpretation: 
-   Rows represent taxa and columns represent detection thresholds.

-   Colors indicate the proportion of samples in which the taxon is detected at or above the threshold.

-   Taxa with high prevalence across multiple thresholds are strong candidates for being part of the core microbiome.

-   Patterns can be compared across taxonomic levels (e.g., Phylum vs. Genus) for broader or finer biological insights.

# Alpha Diversity:

Alpha diversity metrics quantify the diversity within a single microbial community (sample). They describe both richness (number of taxa) and evenness (how uniformly the taxa are distributed). Commonly used indices include Observed, Chao1, ACE (richness estimators), Shannon (balance between richness and evenness), and Simpson (probability that two individuals randomly selected belong to the same species).

```{r alpha_diversity, include=TRUE, echo= FALSE, out.width="49%", fig.show='hold'}
# --- ALPHA DIVERSITY (Intelligent: Boxplot for Groups / Scatter + Gradient for Numeric) ---
# Search directly in Output/
alpha_files <- list.files(output_dir, pattern = "alpha_diversity_.*\\.png", full.names = TRUE)

if(length(alpha_files) > 0) {
  for(f in alpha_files) {
    cat(paste0("![](", f, ")\n\n"))
  }
} else {
  print_warning("No Alpha Diversity plots generated. Check your metadata groups.")
}
```

### Interpretation: 
-   Observed: the raw count of taxa detected in each sample.

-   Chao1: an estimator that infers the total richness by accounting for rare taxa.

-   se.chao1: the standard error of the Chao1 estimate.

-   ACE: another estimator of species richness using abundance-based coverage.

-   se.ACE: the standard error associated with the ACE estimate.

-   Shannon: considers both richness and evenness; higher values indicate more balanced and diverse communities.

-   Simpson: emphasizes evenness and dominance; lower values reflect higher diversity (i.e., less dominance by few taxa).

> -- These metrics are useful to compare how diverse microbial communities are across treatments or conditions. Large differences in alpha diversity may indicate ecological responses to environmental or experimental variables. -- Use this analysis to pinpoint key taxa that respond to experimental treatments or environmental gradients.

# Beta Diversity:

Beta diversity evaluates the differences in microbial composition between samples or groups. It measures the extent to which communities share similar taxa and relative abundances. NMDS (Non-metric Multidimensional Scaling) is a common ordination method used to visualize beta diversity.

## NMDS

```{r beta_diversity_nmds_pcoa, include=TRUE, echo= FALSE}
# --- BETA DIVERSITY (NMDS & PCoA) ---
plot_files <- list.files(output_dir, pattern = "beta_diversity_.*\\.png", full.names = TRUE)
beta_files <- plot_files[!grepl("RDA", plot_files)]

if(length(beta_files) > 0) {
  for(f in beta_files) {
    cat(paste0("![](", f, ")\n\n"))
  }
} else {
  print_warning("No Beta Diversity plots generated. Requires sufficient sample variance.")
}
```

### Interpretation: 
Each point represents a microbial community from a sample. - Samples closer together are more similar in composition. - Ellipses indicate clustering patterns by metadata group. - NMDS (Non-metric Multidimensional Scaling): focuses on rank-order distances; does not preserve exact distances but reveals relative similarities. Good for complex, non-linear relationships. - PCoA (Principal Coordinates Analysis): preserves actual distances as well as possible; useful when understanding variance structure of dissimilarity matrix.



# Global RDA (Redundancy Analysis):

Global RDA is a constrained ordination method used to quantify how much of the variation in community composition can be explicitly explained by environmental or metadata variables. Unlike unconstrained methods (like PCoA or NMDS) that visualize total variation, RDA models the linear relationship between species abundance (Hellinger-transformed) and explanatory variables.

```{r rda-analysis, out.width="49%", fig.show='hold', fig.align='default'}
rda_files <- list.files(output_dir, pattern = "beta_diversity_RDA.*\\.png", full.names = TRUE)

if(length(rda_files) > 0) {
  for(f in rda_files) {
    cat(paste0("![](", f, ")\n\n"))
  }
} else {
  print_warning("RDA skipped. This analysis requires **Numeric** environmental variables (e.g., pH, Temperature) in the metadata.")
}
```

### Interpretation:

RDA Axes: The percentage of variance shown on the axes (RDA1, RDA2) represents the variation explained by your metadata constraints.

Arrows (Vectors): Indicate the direction and strength of continuous numeric variables (e.g., pH, Temperature). Longer arrows indicate stronger correlations with community structure.

Centroids (Labels): Represent the "center of gravity" for categorical groups (e.g., Different Sites or Treatments). Samples clustering near a centroid are associated with that condition.

Adjusted R²: Represents the total percentage of community variation explained by the combination of all metadata variables provided.

Significance (ANOVA): A permutation test is performed on the RDA model to determine if the relationship between the metadata and the community is statistically significant (p \< 0.05).

# Deseq2:

DESeq2 identifies taxa that are differentially abundant between sample groups based on count data. It models the counts using a negative binomial distribution and performs statistical testing to identify significant log2 fold changes between conditions.

```{r deseq2-analysis, out.width="49%", fig.show='hold', fig.align='default'}
deseq_files <- list.files(output_dir, pattern = "deseq2_diff_.*\\.png", full.names = TRUE)

if(length(deseq_files) > 0) {
  for(f in deseq_files) {
    cat(paste0("![](", f, ")\n\n"))
  }
} else {
  print_warning("No significant results from DESeq2. This analysis requires at least 2 groups with replicates. If skipped, check if your groups have enough samples.")
}
```

### Interpretation:

Log2 Fold Change (LFC): Indicates the magnitude and direction of the change.

Positive LFC (\> 0): The taxon is more abundant in the first group listed in the plot title (e.g., in "Mud vs Grass", blue bars indicate enrichment in Mud).

Negative LFC (\< 0): The taxon is more abundant in the second group (reference group).

padj (Adjusted P-value): Only taxa with a False Discovery Rate (FDR) adjusted p-value \< 0.05 are considered significant and displayed.

Taxonomic Level: Analyses are run at multiple ranks (Phylum to OTU) to detect both broad community shifts and specific bioindicators.

# ANCOM-BC Analysis:

ANCOM-BC (Analysis of Compositions of Microbiomes with Bias Correction) is a method designed to identify differentially abundant taxa while accounting for the compositional nature of microbiome data (where total counts are constrained). It estimates the unknown sampling fractions and corrects the bias introduced by differences in sequencing depth.

```{r ancombc-analysis, out.width="49%", fig.show='hold', fig.align='default', results='asis'}
ancom_files <- list.files(output_dir, pattern = "ancombc_heatmap_.*\\.png", full.names = TRUE)

if(length(ancom_files) > 0) {
  for(f in ancom_files) {
    cat(paste0("![](", f, ")\n\n"))
  }
} else {
  print_warning("No significant results from ANCOM-BC.")
}
```

### Interpretation:

Log Fold Change (Bias Corrected): Represents the magnitude of change in taxon abundance between groups after correcting for sampling bias.

Direction: Blue indicates enrichment (increase) in the comparison group relative to the reference; Red indicates depletion.

Unlike standard methods, ANCOM-BC explicitly models the sampling fraction, making it robust for datasets where the microbial load varies significantly between samples.

```{r end, include=FALSE, echo= FALSE}
gc() 
message("Script executed successfully. All results have been saved in the 'Output' folder.")
```
